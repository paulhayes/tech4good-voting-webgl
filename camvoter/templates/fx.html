<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello World</title>
  <style>
    html, body {
      margin:0;
    }
  </style>
</head>
<body>
<canvas id="viewport" width="640" height="480"></canvas>
<script src="static/js/dat.gui.min.js"></script>
<script type="text/javascript" src="static/js/socket.io.min.js"></script>
<script src="static/js/jquery-1.11.0.min.js"></script>

<script id="fragment" type="x-shader/x-fragment">
#ifdef GL_ES
precision lowp float;
#endif

uniform vec2 resolution;
uniform float progress;
uniform float time;
#define PI 3.1414159265359
#define M  0.9
#define D  0.6

#define fmod 0.1

void main()
{
  vec2 p = (gl_FragCoord.xy - 0.5* resolution) / min(resolution.x, resolution.y);
  vec2 t = vec2(gl_FragCoord.xy / resolution);
  vec3 c = vec3(0);
  float y=0.;
  float x=0.;
  float pg = pow(progress,0.75);
  for(int i = 0; i < 200; i++) {
    float t =  float(i) * (50.*pg);
     x = float(i) / (200.*1./1.3) * pg * sin( time + 0.007*t);
     y = -1.3 * cos( t * 0.001);
    vec2 o = 0.3 * vec2(x, y);
    float r = fract(y+x);
    float g = 1. - r;
    c += (0.8*pg+0.2)*0.0007 / (length(p-o)) * vec3(r, g, 0.1*y+1.);
  }
  
  //vec3 oscColor = mix(c, vec3(1, 1, 1)-c, 0.);
  gl_FragColor = vec4(c, 1);  
}
</script>

<script src="static/js/glsl.min.js"></script>

<script>
  if (!Glsl.supported()) alert("WebGL is not supported.");
  lastTotalVotes = window.totalVotes = 0;
  var parameters = {
    voters : 1,
    duration : 10
  };
  var glsl = Glsl({
    canvas: document.getElementById("viewport"),
    fragment: document.getElementById("fragment").textContent,
    variables: {
      time: 0, // The time in ms
      progress: 0
    },
    update: function (time) {
      var easedVotes = 0.2 * ( window.totalVotes ) + 0.8 * ( window.lastTotalVotes ) ;
      window.lastTotalVotes = easedVotes;


      this.set("time", time / 1000 );
      this.set("progress", easedVotes / ( parameters.duration * parameters.voters ) );
      this.set("resolution", {x:this.variables.screenWidth,y:this.variables.screenHeight});

    }
  }).start();
  var gui = new dat.GUI();
  
  function onWindowResize( event ) {
      glsl.canvas.width = window.innerWidth;
      glsl.canvas.height = window.innerHeight;
      glsl.gl.viewport( 0, 0, glsl.canvas.width, glsl.canvas.height );
      glsl.variables.screenWidth = window.innerWidth;
      glsl.variables.screenHeight = window.innerHeight;

  }

  function requestFullScreen() {
    var element = document.body;
    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

    if (requestMethod) { 
        requestMethod.call(element,Element.ALLOW_KEYBOARD_INPUT);
    }
  }

  //requestFullScreen(document.body);
  onWindowResize();
  window.addEventListener( 'resize', onWindowResize, false );
  glsl.variables.fullscreen = requestFullScreen;


  gui.add(glsl.variables,"fullscreen");
  //gui.add(glsl.variables,"progress",0,1);
  gui.add(parameters,"voters",1,500);
  gui.add(parameters,"duration",1,10);

$(document).ready(function(){
    var width = 200, height = 200;
    var lastVoteCount = 0;
    var lastVoteTime = Date.now();
    var totalVotes = 0;
    var isVoting = false;
    var voteDuration = 10;
    
    $(document).keypress(function(e){
        console.log(e);
        if( e.keyCode == 32 ) startVoting();
        if( e.keyCode == 99 ) clearVoting();
    });
    
    var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');
    socket.on('vote count', function(msg) {
        var count = msg.data.count;
        
        //$('#vote_count').html('<p>Received: ' + JSON.stringify(msg.data) + '</p>');
        var voteTime = Date.now();
        if( voteDuration < 0.001*( voteTime - voteStartTime ) ){
            isVoting = false;
            voteTime = voteStartTime+1000*voteDuration;
        }
        totalVotes += 0.5 * ( lastVoteCount + count ) * 0.001 * ( voteTime - lastVoteTime );
        lastVoteTime = voteTime;
        lastVoteCount = count;
        window.totalVotes = totalVotes;
        $('#vote_count').html('<p>'+totalVotes+'</p>');
    });

    var startVoting = function(){
        clearVoting();
        lastVoteTime = voteStartTime = Date.now();
        isVoting = true;
    }

    var clearVoting = function(){
        window.lastTotalVotes = window.totalVotes = 0;
        totalVotes = 0;
        lastVoteCount = 0;
        isVoting = false;
    }

    setInterval(function() {
        if( isVoting ) socket.emit('get votes', {'data':'nothing to say'});
        
    }, 100); 
});


</script>
</body>
</html>
